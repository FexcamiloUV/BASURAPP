<ion-app>

  <!-- CONTENIDO PRINCIPAL CON EL ID QUE COINCIDE -->
  <div id="main-content">
    
    <ion-header [translucent]="true" class="header-custom">
      <ion-toolbar color="primary">
        
        <!-- BOTÓN PARA ABRIR EL MENÚ -->
        <ion-buttons slot="start">
        <ion-button fill="clear" slot="start" (click)="logout()">
          <ion-icon slot="start" name="log-out"></ion-icon>
        </ion-button>
          </ion-buttons>

        <div class="header-content">
          <div class="header-title">
            <ion-icon name="navigate" class="header-icon"></ion-icon>
            <span>Seguimiento GPS</span>
          </div>
          <div class="header-status" *ngIf="modoRecorrido">
            <ion-badge color="success" class="live-badge">
              <ion-icon name="radio"></ion-icon>
              EN VIVO
            </ion-badge>
          </div>
        </div>
        
        <ion-buttons slot="end">
          <ion-button class="notification-btn">
            <ion-icon name="notifications" color="light"></ion-icon>
            <ion-badge color="danger" *ngIf="notificacionesPendientes > 0" class="notification-badge">
              {{notificacionesPendientes}}
            </ion-badge>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>


    <ion-content [fullscreen]="true" class="content-custom">
      <div class="map-section">
        <div id="mapId" class="map-container"></div>
        <div class="map-overlay-controls">
        </div>
      </div>

      <div class="control-panel">
        <div class="mode-selector-card">
          <div class="section-header">
            <ion-icon name="options" color="primary"></ion-icon>
            <h3>Modo de Operación</h3>
          </div>
          
          <ion-segment [value]="modoOperacion" (ionChange)="cambiarModoOperacion($event)" class="mode-segment">
            <ion-segment-button value="tiempo-real" class="mode-option">
              <ion-icon name="radio"></ion-icon>
              <ion-label>Tiempo Real</ion-label>
            </ion-segment-button>
            <ion-segment-button value="simulacion" class="mode-option">
              <ion-icon name="play-circle"></ion-icon>
              <ion-label>Simulación</ion-label>
            </ion-segment-button>
          </ion-segment>
          
          <div class="mode-description">
            <p>
              <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play-circle'" 
                      [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'"></ion-icon>
              {{ modoOperacion === 'tiempo-real' ? 
                'Usando GPS real para seguimiento en tiempo real' : 
                'Movimiento simulado para pruebas y demostraciones' }}
            </p>
          </div>
        </div>

        <div class="config-card">
          <div class="section-header">
            <ion-icon name="settings" color="primary"></ion-icon>
            <h3>Configuración del Recorrido</h3>
          </div>
          
          <div class="config-grid">
            <div class="config-item">
              <label class="config-label">
                <ion-icon name="map" color="primary"></ion-icon>
                Ruta
              </label>
              <div class="select-wrapper">
                <ion-select 
                  [(ngModel)]="rutaSeleccionada"
                  placeholder="Seleccionar ruta"
                  interface="action-sheet"
                  class="modern-select"
                  (ionChange)="seleccionarRuta($event)">
                  <ion-select-option *ngFor="let ruta of rutasGuardadas" [value]="ruta">
                    <div class="select-option">
                      <ion-icon name="trail-sign" color="primary"></ion-icon>
                      <div class="option-text">
                        <strong>{{ ruta.nombre_ruta }}</strong>
                      </div>
                    </div>
                  </ion-select-option>
                </ion-select>
                <ion-icon name="chevron-down" class="select-arrow"></ion-icon>
              </div>
            </div>

            <div class="config-item">
              <label class="config-label">
                <ion-icon name="car" color="primary"></ion-icon>
                Vehículo
              </label>
              <div class="select-wrapper">
                <ion-select 
                  [(ngModel)]="vehiculoSeleccionado"
                  placeholder="Seleccionar vehículo"
                  interface="action-sheet"
                  class="modern-select"
                  (ionChange)="seleccionarVehiculo($event)">
                  <ion-select-option *ngFor="let vehiculo of vehiculo" [value]="vehiculo">
                    <div class="select-option">
                      <ion-icon name="car-sport" color="primary"></ion-icon>
                      <div class="option-text">
                        <strong>{{ vehiculo.marca }}</strong>
                        <small>{{ vehiculo.placa }}</small>
                      </div>
                    </div>
                  </ion-select-option>
                </ion-select>
                <ion-icon name="chevron-down" class="select-arrow"></ion-icon>
              </div>
            </div>
          </div>
        </div>

        <div class="info-card" *ngIf="rutaSeleccionada">
          <div class="section-header">
            <ion-icon name="information-circle" color="primary"></ion-icon>
            <h3>Información del Recorrido</h3>
          </div>
          
          <div class="route-info">
            <div class="route-main">
              <div class="route-icon">
                <ion-icon name="trail-sign" color="primary"></ion-icon>
              </div>
              <div class="route-details">
                <h4>{{ rutaSeleccionada.nombre_ruta }}</h4>
                <p class="route-meta">
                  <span class="meta-item">
                    <ion-icon name="location"></ion-icon>
                    {{ puntosRutaActual?.length || 0 }} puntos
                  </span>
                  <span class="meta-item" *ngIf="vehiculoSeleccionado">
                    <ion-icon name="car-sport"></ion-icon>
                    {{ vehiculoSeleccionado.placa }}
                  </span>
                </p>
              </div>
            </div>
            
            <div class="progress-section">
              <div class="progress-header">
                <span>Progreso</span>
                <span class="progress-percent">{{ progresoRuta.toFixed(1) }}%</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="progresoRuta"></div>
                </div>
                <div class="progress-indicator" [style.left.%]="progresoRuta">
                  <div class="indicator-dot"></div>
                </div>
              </div>
              <div class="progress-stats">
                <span *ngIf="modoOperacion === 'simulacion'">
                  Punto {{ indicePuntoActual + 1 }} de {{ puntosRutaActual.length }}
                </span>
                <span *ngIf="modoOperacion === 'tiempo-real'">
                  Seguimiento activo
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="action-card">
          <ion-button 
            class="main-action-btn"
            [color]="modoRecorrido ? 'danger' : 'success'" 
            (click)="toggleRecorridoMode()" 
            [disabled]="!rutaSeleccionada"
            expand="block"
            shape="round"
            size="large">
            <div class="btn-content">
              <div class="btn-icon">
                <ion-icon 
                  [name]="modoRecorrido ? 'stop-circle' : 'play-circle'"
                  class="action-icon">
                </ion-icon>
              </div>
              <div class="btn-text">
                <span class="btn-title">
                  {{ modoRecorrido ? 'DETENER' : 'INICIAR' }}
                </span>
                <span class="btn-subtitle">
                  {{ modoOperacion === 'tiempo-real' ? 'TIEMPO REAL' : 'SIMULACIÓN' }}
                </span>
              </div>
            </div>
          </ion-button>

          <div class="action-info" *ngIf="!rutaSeleccionada">
            <ion-icon name="alert-circle" color="medium"></ion-icon>
            <span>Selecciona una ruta y vehículo para comenzar</span>
          </div>
        </div>

        <div class="status-card" *ngIf="modoRecorrido">
          <div class="status-header">
            <div class="live-indicator">
              <div class="pulse-dot" [class]="modoOperacion === 'tiempo-real' ? 'real-pulse' : 'sim-pulse'"></div>
              <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play-circle'"></ion-icon>
              <span>RECORRIDO ACTIVO</span>
            </div>
            <div class="status-mode">
              <ion-badge [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'">
                {{ modoOperacion === 'tiempo-real' ? 'REAL' : 'SIM' }}
              </ion-badge>
            </div>
          </div>
          
          <div class="status-grid">
            <div class="status-item">
              <div class="status-icon">
                <ion-icon name="speedometer" color="primary"></ion-icon>
              </div>
              <div class="status-text">
                <label>Progreso</label>
                <strong>{{ progresoRuta.toFixed(1) }}%</strong>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <ion-icon name="trail-sign" color="primary"></ion-icon>
              </div>
              <div class="status-text">
                <label>Ruta</label>
                <strong>{{ rutaSeleccionada?.nombre_ruta }}</strong>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <ion-icon name="car-sport" color="primary"></ion-icon>
              </div>
              <div class="status-text">
                <label>Vehículo</label>
                <strong>{{ vehiculoSeleccionado?.placa }}</strong>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <ion-icon name="time" color="primary"></ion-icon>
              </div>
              <div class="status-text">
                <label>Estado</label>
                <strong>{{ modoOperacion === 'tiempo-real' ? 'En movimiento' : 'Simulando' }}</strong>
              </div>
            </div>
          </div>
          
          <div class="status-footer" [class]="modoOperacion === 'tiempo-real' ? 'real-time' : 'simulation'">
            <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'cellular' : 'play'"></ion-icon>
            <span>
              {{ modoOperacion === 'tiempo-real' ? 
                'Enviando ubicación en tiempo real' : 
                'Movimiento simulado activo' }}
            </span>
          </div>
        </div>
      </div>

      <div class="scroll-spacer"></div>
    </ion-content>
  </div>
</ion-app>