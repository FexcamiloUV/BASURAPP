<ion-menu side="start" menuId="admin-menu" contentId="home-conductor-content">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>{{userName}}</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
     
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header [translucent]="true" class="header-custom">
  <ion-toolbar color="primary" class="toolbar-gradient">
    <!-- Botón del menú -->
    <ion-buttons slot="start">
      <ion-menu-button menu="admin-menu" class="menu-button">
        <ion-icon name="menu" color="light"></ion-icon>
      </ion-menu-button>
    </ion-buttons>
    
    <ion-title class="header-title">
      <ion-icon name="map-outline" style="vertical-align: middle; margin-right: 8px;"></ion-icon>
      Mapa del Administrador 
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button (click)="toggleRutasGuardadas()" class="header-btn">
        <ion-icon name="eye" color="light"></ion-icon>
      </ion-button>
      <ion-button class="header-btn">
        <ion-icon name="notifications" color="light"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" scrollY="false" id="main-content">
  <div class="map-container">
    <!-- Mapa principal -->
    <div id="mapId" style="height: 65vh; width: 100%;"></div>
    
    <!-- Botón ojito en el mapa -->
    <div class="map-overlay-controls">
      <div class="map-floating-buttons">
        <ion-button class="map-eye-button" (click)="abrirModalRutas()" shape="round">
          <ion-icon name="eye" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button class="map-locate-button" shape="round">
          <ion-icon name="locate" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
    
    <!-- Mini panel de estado -->
    <div class="status-panel">
      <ion-badge [color]="modoRecorrido ? 'success' : 'medium'" class="status-badge">
        <ion-icon [name]="modoRecorrido ? 'play' : 'stop'" style="margin-right: 4px;"></ion-icon>
        {{ modoRecorrido ? 'GRABANDO' : 'DETENIDO' }}
      </ion-badge>
      <span class="status-text">{{ puntosRecorrido.length }} puntos</span>
    </div>
  </div>

  <!-- Alert para mensajes -->
  <ion-alert [isOpen]="showAlert" [message]="alertMessage" [buttons]="['OK']"
    (didDismiss)="showAlert = false"></ion-alert>

  <!-- Panel de configuración compacto -->
  <div class="control-panel">
    <!-- Nombre de ruta -->
    <div class="route-name-card">
      <ion-item class="route-name-item">
        <ion-icon name="flag" slot="start" color="primary"></ion-icon>
        <ion-input [(ngModel)]="nombreRuta" placeholder="Nombre de la ruta" 
          (ionInput)="actualizarRutaCompleta()" clearInput></ion-input>
      </ion-item>
    </div>

    <!-- Controles de acción principales -->
    <div class="action-controls">
      <ion-button expand="block" [color]="modoRecorrido ? 'danger' : 'success'" 
        (click)="toggleModoRecorrido()" class="record-button">
        <ion-icon slot="start" [name]="modoRecorrido ? 'stop-circle' : 'radio-button-on'"></ion-icon>
        {{ modoRecorrido ? 'DETENER' : 'INICIAR RUTA' }}
      </ion-button>
      
      <div class="secondary-controls">
        <ion-button expand="block" color="primary" (click)="guardarRuta()"
          [disabled]="!rutaCompleta || guardandoRuta" class="action-btn">
          <ion-spinner *ngIf="guardandoRuta" name="lines"></ion-spinner>
          <ion-icon *ngIf="!guardandoRuta" slot="start" name="save"></ion-icon>
          {{ guardandoRuta ? 'GUARDANDO' : 'GUARDAR' }}
        </ion-button>
        
        <ion-button expand="block" color="danger" (click)="eliminarRecorrido()"
          [disabled]="puntosRecorrido.length === 0" class="action-btn">
          <ion-icon slot="start" name="trash"></ion-icon>
          LIMPIAR
        </ion-button>
        
        <ion-button expand="block" color="medium" (click)="toggleJsonPreview()" class="action-btn">
          <ion-icon slot="start" name="code"></ion-icon>
          JSON
        </ion-button>
      </div>
    </div>

    <!-- Preview del JSON (se muestra/oculta) -->
    <div *ngIf="showJsonPreview && rutaCompleta" class="json-preview">
      <div class="json-header">
        <h3>Vista previa JSON</h3>
        <ion-button fill="clear" size="small" (click)="toggleJsonPreview()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      <div class="json-content">
        <pre>{{ getRutaFormateada(rutaCompleta) }}</pre>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-overlay">
      <div class="loading-content">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Cargando mapa...</p>
      </div>
    </div>
  </div>

  <!-- Modal para Rutas Guardadas -->
  <ion-modal [isOpen]="modalRutasAbierto" (didDismiss)="cerrarModalRutas()" class="custom-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Rutas Guardadas</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModalRutas()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="modal-actions">
          <ion-button expand="block" color="secondary" (click)="cargarRutasGuardadas()"
            [disabled]="cargandoRutas" class="refresh-btn">
            <ion-spinner *ngIf="cargandoRutas" name="lines"></ion-spinner>
            <ion-icon *ngIf="!cargandoRutas" slot="start" name="refresh"></ion-icon>
            Actualizar Rutas
          </ion-button>
        </div>

        <div *ngIf="rutasGuardadas.length > 0; else sinRutas" class="routes-list">
          <ion-list>
            <ion-item *ngFor="let ruta of rutasGuardadas; let i = index" class="route-item">
              <ion-icon name="map" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>{{ ruta.nombre_ruta }}</h3>
              </ion-label>
              <div slot="end" class="route-actions">
                <ion-button color="primary" size="small" (click)="centrarEnRuta(ruta)">
                  <ion-icon name="locate"></ion-icon>
                </ion-button>
                <ion-button color="danger" size="small" (click)="eliminarRuta(ruta.id , ruta.nombre_ruta) ">
                  <ion-icon name="trash"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
        </div>

        <ng-template #sinRutas>
          <div class="no-routes">
            <ion-icon name="map-outline" color="medium"></ion-icon>
            <p>No hay rutas guardadas</p>
            <p class="hint">Crea una ruta y guárdala para verla aquí</p>
          </div>
        </ng-template>

        <ion-button expand="block" color="medium" (click)="cerrarModalRutas()" class="close-modal-btn">
          Cerrar
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>