<ion-content [fullscreen]="true">
  
  <div id="mapId" class="map-container"></div>

  <div class="loading-overlay" *ngIf="isLoading">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando mapa...</p>
  </div>

  <div class="top-tools">
    <ion-button class="tool-btn" color="light" (click)="centrarEnUbicacionActual()">
      <ion-icon name="location" color="primary"></ion-icon>
    </ion-button>
    
    <ion-button class="tool-btn" color="light" (click)="toggleRutasGuardadas()">
      <ion-icon [name]="mostrarRutasGuardadas ? 'eye-off' : 'eye'" color="secondary"></ion-icon>
    </ion-button>
  </div>

  <div class="floating-card list-panel" *ngIf="mostrarRutasGuardadas">
    <div class="panel-header">
      <h3>Rutas Guardadas</h3>
      <ion-button fill="clear" size="small" color="medium" (click)="toggleRutasGuardadas()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </div>

    <div class="scrollable-list">
      <ion-spinner *ngIf="cargandoRutas" class="spinner-center"></ion-spinner>
      
      <div *ngIf="!cargandoRutas">
        <div class="empty-state" *ngIf="rutasGuardadas.length === 0">
          <ion-icon name="map-outline"></ion-icon>
          <p>No hay rutas guardadas</p>
        </div>

        <ion-item-sliding *ngFor="let ruta of rutasGuardadas" class="route-item">
          <ion-item lines="none" detail="false">
            <ion-label>
              <h3>{{ ruta.nombre }}</h3>
              <p class="desc">{{ ruta.descripcion || 'Sin descripci√≥n' }}</p>
              <p class="date">{{ ruta.creado_en | date:'short' }}</p>
            </ion-label>
            <ion-button slot="end" fill="clear" (click)="cargarRutaEnMapa(ruta)">
              <ion-icon name="cloud-download" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="danger" (click)="eliminarRuta(ruta)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Borrar
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </div>
    </div>
  </div>

  <div class="control-panel creator-panel">
    <div class="panel-header">
      <h3>Editor de Ruta</h3>
      <span class="status-badge" [class.ready]="puntos.length >= 2">
        {{ puntos.length >= 2 ? 'Lista para guardar' : 'Editando...' }}
      </span>
    </div>

    <div class="stats-row">
      <div class="stat">
        <small>Puntos</small>
        <strong>{{ puntos.length }}</strong>
      </div>
      <div class="stat">
        <small>Distancia</small>
        <strong>{{ calcularDistanciaTotal().toFixed(2) }} km</strong>
      </div>
    </div>

    <p class="help-text" *ngIf="puntos.length < 2">
      <ion-icon name="finger-print"></ion-icon>
      Toca el mapa para agregar puntos
    </p>

    <div class="actions-grid">
      <ion-button color="danger" fill="outline" (click)="limpiarRuta()" [disabled]="puntos.length === 0">
        <ion-icon name="trash" slot="icon-only"></ion-icon>
      </ion-button>

      <ion-button color="warning" fill="outline" (click)="exportarGeoJSON()" [disabled]="puntos.length === 0">
        <ion-icon name="download" slot="icon-only"></ion-icon>
      </ion-button>

      <ion-button class="save-btn" color="success" (click)="guardarRuta()" [disabled]="puntos.length < 2 || guardando">
        <ion-icon name="save" slot="start"></ion-icon>
        <ion-spinner *ngIf="guardando" name="dots"></ion-spinner>
        <span *ngIf="!guardando">Guardar</span>
      </ion-button>
    </div>
  </div>

</ion-content>